{% extends 'proxy/base.html' %}

{% block title %}Manage Proxy{% endblock %}

{% block content %}
<section class="card">
  <h2>Proxy Configuration</h2>
  <form method="post">
    {% csrf_token %}
    <input type="hidden" name="action" value="update_config">
    <div class="form-row">
      <label for="id_strategy">Strategy</label>
      {{ config_form.strategy }}
    </div>
    <div class="form-row">
    </div>
    <div class="form-row">
      <button type="submit">Save Config</button>
    </div>
  </form>
</section>

<section class="card">
  <h2>Nodes</h2>
  <div class="nodes-header">
    <button id="open-add-node" class="add-node-btn">Add Node</button>
  </div>
  <table class="nodes">
    <thead><tr><th>ID</th><th>Name</th><th>Address</th><th>Port</th><th>Active</th><th>Actions</th></tr></thead>
    <tbody>
      {% for n in nodes %}
        <tr>
          <td>{{ n.id }}</td>
          <td>{{ n.name }}</td>
          <td>{{ n.address }}</td>
          <td>{{ n.port }}</td>
          <td>{{ n.active }}</td>
          <td>
            <button class="details-node-btn" data-id="{{ n.id }}">Details</button>
            &nbsp;
            <button class="edit-node-btn" data-id="{{ n.id }}" data-name="{{ n.name }}" data-address="{{ n.address }}" data-port="{{ n.port }}">Update</button>
            &nbsp;
            <form method="post" style="display:inline">
              {% csrf_token %}
              <input type="hidden" name="action" value="delete_node">
              <input type="hidden" name="node_id" value="{{ n.id }}">
              <button type="submit" class="btn-danger">Delete</button>
            </form>
          </td>
        </tr>
      {% empty %}
        <tr><td colspan="6">No nodes configured</td></tr>
      {% endfor %}
    </tbody>
    <!-- Hidden Add Node form will be shown in modal -->
  
</section>

<section class="card">
  <h2>Available Models (aggregated)</h2>
  <div style="margin-bottom:8px">
    <button id="refresh-models">Refresh Models</button>
  </div>
  <table id="models-table" class="nodes" style="width:100%">
    <thead><tr><th>Model</th></tr></thead>
    <tbody>
      <tr><td>Loading...</td></tr>
    </tbody>
  </table>
</section>

  <!-- Edit/Add Node Modal -->
  <div id="node-modal" class="modal" aria-hidden="true" style="display:none">
    <div class="modal-content">
      <button id="modal-close" class="modal-close">×</button>
      <h3 id="modal-title">Edit Node</h3>
      <form id="modal-form" method="post">
        {% csrf_token %}
        <input type="hidden" name="node_id" id="modal-node-id" value="">
        <input type="hidden" name="action" id="modal-action" value="">
        <div class="form-row">
          <label for="modal-name">Name</label>
          <input id="modal-name" type="text" name="name" required />
        </div>
        <div class="form-row">
          <label for="modal-address">Domain / IP</label>
          <input id="modal-address" type="text" name="address" required />
        </div>
        <div class="form-row">
          <label for="modal-port">Port</label>
          <input id="modal-port" type="number" name="port" required />
        </div>
        <div class="form-row">
          <button type="submit" id="modal-submit">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Node Details Modal -->
  <div id="details-modal" class="modal" aria-hidden="true" style="display:none">
    <div class="modal-content modal-content-wide">
      <button id="details-modal-close" class="modal-close">×</button>
      <h3 id="details-modal-title">Node Details</h3>
      <div id="details-content">
        <div class="details-loading">Loading...</div>
      </div>
    </div>
  </div>

  <script>
  // Modal handling for Add / Edit Node
  const modal = document.getElementById('node-modal');
  const modalTitle = document.getElementById('modal-title');
  const modalForm = document.getElementById('modal-form');
  const modalNodeId = document.getElementById('modal-node-id');
  const modalAction = document.getElementById('modal-action');
  const modalName = document.getElementById('modal-name');
  const modalAddress = document.getElementById('modal-address');
  const modalPort = document.getElementById('modal-port');
  const openAddBtn = document.getElementById('open-add-node');
  const closeBtn = document.getElementById('modal-close');

  function openModal(mode, data) {
    modal.style.display = 'flex';
    modal.setAttribute('aria-hidden', 'false');
    if (mode === 'add') {
      modalTitle.textContent = 'Add Node';
      modalAction.value = 'add_node';
      modalNodeId.value = '';
      modalName.value = '';
      modalAddress.value = '';
      modalPort.value = '';
    } else {
      modalTitle.textContent = 'Edit Node';
      modalAction.value = 'edit_node';
      modalNodeId.value = data.id || '';
      modalName.value = data.name || '';
      modalAddress.value = data.address || '';
      modalPort.value = data.port || '';
    }
  }

  function closeModal() {
    modal.style.display = 'none';
    modal.setAttribute('aria-hidden', 'true');
  }

  document.querySelectorAll('.edit-node-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const id = btn.getAttribute('data-id');
      const name = btn.getAttribute('data-name');
      const address = btn.getAttribute('data-address');
      const port = btn.getAttribute('data-port');
      openModal('edit', { id, name, address, port });
    });
  });

  openAddBtn.addEventListener('click', () => openModal('add', {}));
  closeBtn.addEventListener('click', closeModal);
  window.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });

  // Details Modal handling
  const detailsModal = document.getElementById('details-modal');
  const detailsModalClose = document.getElementById('details-modal-close');
  const detailsContent = document.getElementById('details-content');

  async function fetchNodeDetails(nodeId) {
    try {
      const res = await fetch(`/api/proxy/active-requests?node_id=${nodeId}`, {credentials: 'same-origin'});
      if (!res.ok) { throw new Error('status ' + res.status); }
      const data = await res.json();
      return data.nodes && data.nodes.length > 0 ? data.nodes[0] : null;
    } catch (e) {
      console.error('fetchNodeDetails error', e);
      return null;
    }
  }

  function renderNodeDetails(nodeData) {
    if (!nodeData) {
      detailsContent.innerHTML = '<div class="details-error">Failed to load node details</div>';
      return;
    }

    const latencyText = nodeData.latency !== null && nodeData.latency !== undefined 
      ? (nodeData.latency * 1000).toFixed(2) + ' ms' 
      : 'N/A';

    const modelsHtml = nodeData.models && nodeData.models.length > 0
      ? nodeData.models.map(m => `<li>${m}</li>`).join('')
      : '<li>No models available</li>';

    detailsContent.innerHTML = `
      <div class="details-section">
        <div class="details-row">
          <span class="details-label">ID:</span>
          <span class="details-value">${nodeData.id}</span>
        </div>
        <div class="details-row">
          <span class="details-label">Name:</span>
          <span class="details-value">${nodeData.name}</span>
        </div>
        <div class="details-row">
          <span class="details-label">Address:</span>
          <span class="details-value">${nodeData.address}</span>
        </div>
        <div class="details-row">
          <span class="details-label">Status:</span>
          <span class="details-value status-${nodeData.status}">${nodeData.status.toUpperCase()}</span>
        </div>
        <div class="details-row">
          <span class="details-label">Active Requests:</span>
          <span class="details-value">${nodeData.active_requests}</span>
        </div>
        <div class="details-row">
          <span class="details-label">Latency:</span>
          <span class="details-value">${latencyText}</span>
        </div>
        <div class="details-row">
          <span class="details-label">Available Models (${nodeData.models ? nodeData.models.length : 0}):</span>
        </div>
        <ul class="details-models">${modelsHtml}</ul>
      </div>
    `;
  }

  function openDetailsModal(nodeId) {
    detailsModal.style.display = 'flex';
    detailsModal.setAttribute('aria-hidden', 'false');
    detailsContent.innerHTML = '<div class="details-loading">Loading...</div>';
    
    fetchNodeDetails(nodeId).then(data => {
      renderNodeDetails(data);
    });
  }

  function closeDetailsModal() {
    detailsModal.style.display = 'none';
    detailsModal.setAttribute('aria-hidden', 'true');
  }

  document.querySelectorAll('.details-node-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const id = btn.getAttribute('data-id');
      openDetailsModal(id);
    });
  });

  detailsModalClose.addEventListener('click', closeDetailsModal);
  window.addEventListener('click', (e) => { if (e.target === detailsModal) closeDetailsModal(); });
  </script>

<script>
async function fetchModels(){
  try{
    const res = await fetch('/api/proxy/tags', {credentials: 'same-origin'});
    if(!res.ok){ throw new Error('status '+res.status); }
    const data = await res.json();
    // /api/proxy/tags returns {"models": [{name, modified_at, size, ...}, ...]}
    return data.models || [];
  }catch(e){
    console.error('fetchModels error', e);
    return [];
  }
}

function renderModels(models){
  const tbody = document.querySelector('#models-table tbody');
  tbody.innerHTML = '';
  // models is now an array of model objects
  if(!Array.isArray(models) || models.length === 0){
    const tr = document.createElement('tr');
    tr.innerHTML = '<td>No models available</td>';
    tbody.appendChild(tr);
    return;
  }
  // Sort by name (already sorted by backend, but ensure it)
  const sortedModels = models.sort((a,b)=>(a.name||'').localeCompare(b.name||''));
  for(const model of sortedModels){
    const name = model.name || '';
    if(!name) continue;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td style="word-break:break-all">${name}</td>`;
    tbody.appendChild(tr);
  }
}

document.getElementById('refresh-models').addEventListener('click', async ()=>{
  document.querySelector('#models-table tbody').innerHTML = '<tr><td>Loading...</td></tr>';
  const models = await fetchModels();
  renderModels(models);
});

// initial load
(async ()=>{ const m = await fetchModels(); renderModels(m); })();
</script>

{% endblock %}
