{% extends 'proxy/base.html' %}

{% block title %}Manage Proxy{% endblock %}

{% block content %}
<!-- 1. Proxy Configuration Section -->
<section class="card">
  <h2>‚öôÔ∏è Proxy Configuration</h2>
  <form method="post">
    {% csrf_token %}
    <input type="hidden" name="action" value="update_config">
    <div class="form-row">
      <label for="id_strategy">Strategy</label>
      {{ config_form.strategy }}
    </div>
    <div class="form-row">
      <button type="submit">Save Config</button>
    </div>
  </form>
</section>

<!-- 2. Overall Dashboard Section -->
<section class="card">
  <h2>üìä Overall Dashboard</h2>
  
  <div class="dashboard-grid">
    <!-- Available Models Card -->
    <div class="dashboard-card">
      <div class="dashboard-card-header">
        <h3>Available Models</h3>
        <button id="refresh-models" class="icon-btn">üîÑ</button>
      </div>
      <div class="model-count-display">
        <div class="big-number" id="model-count">0</div>
        <div class="count-label">Total Models</div>
      </div>
      <div class="models-scroll-container">
        <div id="models-list" class="models-list">
          <div class="loading-text">Loading...</div>
        </div>
      </div>
    </div>

    <!-- Pull to All Nodes Card -->
    <div class="dashboard-card">
      <div class="dashboard-card-header">
        <h3>Pull Model to All Nodes</h3>
      </div>
      <div class="pull-all-form">
        <div class="form-row">
          <label for="pull-all-model-input">Model Name</label>
          <input id="pull-all-model-input" type="text" list="model-suggestions-all" placeholder="Enter or select model name" />
          <datalist id="model-suggestions-all">
            <option value="gpt-oss:20b">gpt-oss:20b</option>
            <option value="embeddinggemma:300m">embeddinggemma:300m</option>
          </datalist>
        </div>
        <button id="show-nodes-preview" class="btn-secondary">Preview Nodes Status</button>
        <div id="nodes-preview" class="nodes-preview" style="display:none"></div>
        <button id="pull-all-submit" class="btn-primary">Pull to All Active Nodes</button>
        <div id="pull-all-status" class="pull-status" style="display:none"></div>
      </div>
    </div>
  </div>
</section>

<!-- 3. Nodes Dashboard Section -->
<section class="card">
  <h2>üñ•Ô∏è Nodes Dashboard</h2>
  <div class="nodes-header">
    <button id="open-add-node" class="add-node-btn">+ Add Node</button>
  </div>
  <table class="nodes">
    <thead><tr><th>ID</th><th>Name</th><th>Address</th><th>Port</th><th>Active</th><th>Actions</th></tr></thead>
    <tbody>
      {% for n in nodes %}
        <tr>
          <td>{{ n.id }}</td>
          <td>{{ n.name }}</td>
          <td>{{ n.address }}</td>
          <td>{{ n.port }}</td>
          <td>{{ n.active }}</td>
          <td>
            <button class="details-node-btn" data-id="{{ n.id }}">Details</button>
            &nbsp;
            <button class="pull-node-btn" data-id="{{ n.id }}" data-name="{{ n.name }}">Pull</button>
            &nbsp;
            <button class="edit-node-btn" data-id="{{ n.id }}" data-name="{{ n.name }}" data-address="{{ n.address }}" data-port="{{ n.port }}">Update</button>
            &nbsp;
            <form method="post" style="display:inline">
              {% csrf_token %}
              <input type="hidden" name="action" value="delete_node">
              <input type="hidden" name="node_id" value="{{ n.id }}">
              <button type="submit" class="btn-danger">Delete</button>
            </form>
          </td>
        </tr>
      {% empty %}
        <tr><td colspan="6">No nodes configured</td></tr>
      {% endfor %}
    </tbody>
  </table>
</section>

  <!-- Edit/Add Node Modal -->
  <div id="node-modal" class="modal" aria-hidden="true" style="display:none">
    <div class="modal-content">
      <button id="modal-close" class="modal-close">√ó</button>
      <h3 id="modal-title">Edit Node</h3>
      <form id="modal-form" method="post">
        {% csrf_token %}
        <input type="hidden" name="node_id" id="modal-node-id" value="">
        <input type="hidden" name="action" id="modal-action" value="">
        <div class="form-row">
          <label for="modal-name">Name</label>
          <input id="modal-name" type="text" name="name" required />
        </div>
        <div class="form-row">
          <label for="modal-address">Domain / IP</label>
          <input id="modal-address" type="text" name="address" required />
        </div>
        <div class="form-row">
          <label for="modal-port">Port</label>
          <input id="modal-port" type="number" name="port" required />
        </div>
        <div class="form-row">
          <button type="submit" id="modal-submit">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Node Details Modal -->
  <div id="details-modal" class="modal" aria-hidden="true" style="display:none">
    <div class="modal-content modal-content-wide">
      <button id="details-modal-close" class="modal-close">√ó</button>
      <h3 id="details-modal-title">Node Details</h3>
      <div id="details-content">
        <div class="details-loading">Loading...</div>
      </div>
    </div>
  </div>

  <!-- Pull Model Modal -->
  <div id="pull-modal" class="modal" aria-hidden="true" style="display:none">
    <div class="modal-content modal-content-wide">
      <button id="pull-modal-close" class="modal-close">√ó</button>
      <h3 id="pull-modal-title">Pull Model</h3>
      <div id="pull-modal-body">
        <div id="pull-node-info" class="pull-node-info">
          <div class="pull-info-loading">Loading node information...</div>
        </div>
        <div class="form-row">
          <label for="pull-model-input">Model Name</label>
          <input id="pull-model-input" type="text" list="model-suggestions" placeholder="Enter or select model name" required />
          <datalist id="model-suggestions">
            <option value="gpt-oss:20b">gpt-oss:20b</option>
            <option value="embeddinggemma:300m">embeddinggemma:300m</option>
          </datalist>
        </div>
        <div id="pull-status" class="pull-status" style="display:none"></div>
        <div class="form-row">
          <button id="pull-submit" class="pull-submit-btn">Pull Model</button>
        </div>
      </div>
    </div>
  </div>

  <script>
  // Modal handling for Add / Edit Node
  const modal = document.getElementById('node-modal');
  const modalTitle = document.getElementById('modal-title');
  const modalForm = document.getElementById('modal-form');
  const modalNodeId = document.getElementById('modal-node-id');
  const modalAction = document.getElementById('modal-action');
  const modalName = document.getElementById('modal-name');
  const modalAddress = document.getElementById('modal-address');
  const modalPort = document.getElementById('modal-port');
  const openAddBtn = document.getElementById('open-add-node');
  const closeBtn = document.getElementById('modal-close');

  function openModal(mode, data) {
    modal.style.display = 'flex';
    modal.setAttribute('aria-hidden', 'false');
    if (mode === 'add') {
      modalTitle.textContent = 'Add Node';
      modalAction.value = 'add_node';
      modalNodeId.value = '';
      modalName.value = '';
      modalAddress.value = '';
      modalPort.value = '';
    } else {
      modalTitle.textContent = 'Edit Node';
      modalAction.value = 'edit_node';
      modalNodeId.value = data.id || '';
      modalName.value = data.name || '';
      modalAddress.value = data.address || '';
      modalPort.value = data.port || '';
    }
  }

  function closeModal() {
    modal.style.display = 'none';
    modal.setAttribute('aria-hidden', 'true');
  }

  document.querySelectorAll('.edit-node-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const id = btn.getAttribute('data-id');
      const name = btn.getAttribute('data-name');
      const address = btn.getAttribute('data-address');
      const port = btn.getAttribute('data-port');
      openModal('edit', { id, name, address, port });
    });
  });

  openAddBtn.addEventListener('click', () => openModal('add', {}));
  closeBtn.addEventListener('click', closeModal);
  window.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });

  // Details Modal handling
  const detailsModal = document.getElementById('details-modal');
  const detailsModalClose = document.getElementById('details-modal-close');
  const detailsContent = document.getElementById('details-content');

  async function fetchNodeDetails(nodeId) {
    try {
      const res = await fetch(`/api/proxy/active-requests?node_id=${nodeId}`, {credentials: 'same-origin'});
      if (!res.ok) { throw new Error('status ' + res.status); }
      const data = await res.json();
      return data.nodes && data.nodes.length > 0 ? data.nodes[0] : null;
    } catch (e) {
      console.error('fetchNodeDetails error', e);
      return null;
    }
  }

  function renderNodeDetails(nodeData) {
    if (!nodeData) {
      detailsContent.innerHTML = '<div class="details-error">Failed to load node details</div>';
      return;
    }

    const latencyText = nodeData.latency !== null && nodeData.latency !== undefined 
      ? (nodeData.latency * 1000).toFixed(2) + ' ms' 
      : 'N/A';

    const modelsHtml = nodeData.models && nodeData.models.length > 0
      ? nodeData.models.map(m => `<li>${m}</li>`).join('')
      : '<li>No models available</li>';

    detailsContent.innerHTML = `
      <div class="details-section">
        <div class="details-row">
          <span class="details-label">ID:</span>
          <span class="details-value">${nodeData.id}</span>
        </div>
        <div class="details-row">
          <span class="details-label">Name:</span>
          <span class="details-value">${nodeData.name}</span>
        </div>
        <div class="details-row">
          <span class="details-label">Address:</span>
          <span class="details-value">${nodeData.address}</span>
        </div>
        <div class="details-row">
          <span class="details-label">Status:</span>
          <span class="details-value status-${nodeData.status}">${nodeData.status.toUpperCase()}</span>
        </div>
        <div class="details-row">
          <span class="details-label">Active Requests:</span>
          <span class="details-value">${nodeData.active_requests}</span>
        </div>
        <div class="details-row">
          <span class="details-label">Latency:</span>
          <span class="details-value">${latencyText}</span>
        </div>
        <div class="details-row">
          <span class="details-label">Available Models (${nodeData.models ? nodeData.models.length : 0}):</span>
        </div>
        <ul class="details-models">${modelsHtml}</ul>
      </div>
    `;
  }

  function openDetailsModal(nodeId) {
    detailsModal.style.display = 'flex';
    detailsModal.setAttribute('aria-hidden', 'false');
    detailsContent.innerHTML = '<div class="details-loading">Loading...</div>';
    
    fetchNodeDetails(nodeId).then(data => {
      renderNodeDetails(data);
    });
  }

  function closeDetailsModal() {
    detailsModal.style.display = 'none';
    detailsModal.setAttribute('aria-hidden', 'true');
  }

  document.querySelectorAll('.details-node-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const id = btn.getAttribute('data-id');
      openDetailsModal(id);
    });
  });

  detailsModalClose.addEventListener('click', closeDetailsModal);
  window.addEventListener('click', (e) => { if (e.target === detailsModal) closeDetailsModal(); });

  // Pull Model Modal handling
  const pullModal = document.getElementById('pull-modal');
  const pullModalClose = document.getElementById('pull-modal-close');
  const pullModalTitle = document.getElementById('pull-modal-title');
  const pullModelInput = document.getElementById('pull-model-input');
  const pullSubmitBtn = document.getElementById('pull-submit');
  const pullStatus = document.getElementById('pull-status');
  const pullNodeInfo = document.getElementById('pull-node-info');
  let currentPullNodeId = null;
  let currentPullNodeName = null;

  async function fetchNodeInfo(nodeId) {
    try {
      const res = await fetch(`/api/proxy/active-requests?node_id=${nodeId}`, {credentials: 'same-origin'});
      if (!res.ok) { throw new Error('status ' + res.status); }
      const data = await res.json();
      return data.nodes && data.nodes.length > 0 ? data.nodes[0] : null;
    } catch (e) {
      console.error('fetchNodeInfo error', e);
      return null;
    }
  }

  function renderPullNodeInfo(nodeData) {
    if (!nodeData) {
      pullNodeInfo.innerHTML = '<div class="pull-info-error">Failed to load node information</div>';
      return;
    }

    const modelsCount = nodeData.models ? nodeData.models.length : 0;
    const modelsHtml = nodeData.models && nodeData.models.length > 0
      ? nodeData.models.map(m => `<li>${m}</li>`).join('')
      : '<li style="color:#999">No models installed</li>';

    pullNodeInfo.innerHTML = `
      <div class="pull-info-section">
        <div class="pull-info-header">
          <strong>Current Models on ${nodeData.name} (${modelsCount})</strong>
        </div>
        <ul class="pull-models-list">${modelsHtml}</ul>
      </div>
    `;
  }

  function openPullModal(nodeId, nodeName) {
    currentPullNodeId = nodeId;
    currentPullNodeName = nodeName;
    pullModal.style.display = 'flex';
    pullModal.setAttribute('aria-hidden', 'false');
    pullModalTitle.textContent = `Pull Model to ${nodeName}`;
    pullModelInput.value = '';
    pullStatus.style.display = 'none';
    pullStatus.textContent = '';
    pullSubmitBtn.disabled = false;
    
    // Load node information
    pullNodeInfo.innerHTML = '<div class="pull-info-loading">Loading node information...</div>';
    fetchNodeInfo(nodeId).then(data => {
      renderPullNodeInfo(data);
    });
  }

  function closePullModal() {
    pullModal.style.display = 'none';
    pullModal.setAttribute('aria-hidden', 'true');
    currentPullNodeId = null;
    currentPullNodeName = null;
  }

  async function pullModelToNode() {
    const modelName = pullModelInput.value.trim();
    if (!modelName) {
      pullStatus.style.display = 'block';
      pullStatus.className = 'pull-status pull-error';
      pullStatus.textContent = 'Please enter a model name';
      return;
    }

    pullSubmitBtn.disabled = true;
    pullStatus.style.display = 'block';
    pullStatus.className = 'pull-status pull-loading';
    pullStatus.textContent = 'Pulling model... This may take a few minutes.';

    try {
      const response = await fetch('/api/proxy/pull', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        credentials: 'same-origin',
        body: JSON.stringify({
          model: modelName,
          node_id: currentPullNodeId
        })
      });

      const data = await response.json();
      
      if (response.ok && data.results && data.results.length > 0) {
        const result = data.results[0];
        if (result.status === 'success') {
          pullStatus.className = 'pull-status pull-success';
          pullStatus.textContent = `‚úì ${result.message}`;
          setTimeout(() => {
            closePullModal();
          }, 2000);
        } else {
          pullStatus.className = 'pull-status pull-error';
          pullStatus.textContent = `‚úó ${result.message}`;
          pullSubmitBtn.disabled = false;
        }
      } else {
        pullStatus.className = 'pull-status pull-error';
        pullStatus.textContent = `‚úó ${data.error || 'Failed to pull model'}`;
        pullSubmitBtn.disabled = false;
      }
    } catch (error) {
      pullStatus.className = 'pull-status pull-error';
      pullStatus.textContent = `‚úó Error: ${error.message}`;
      pullSubmitBtn.disabled = false;
    }
  }

  document.querySelectorAll('.pull-node-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const id = btn.getAttribute('data-id');
      const name = btn.getAttribute('data-name');
      openPullModal(id, name);
    });
  });

  pullSubmitBtn.addEventListener('click', pullModelToNode);
  pullModalClose.addEventListener('click', closePullModal);
  window.addEventListener('click', (e) => { if (e.target === pullModal) closePullModal(); });
  
  // Allow Enter key to submit
  pullModelInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !pullSubmitBtn.disabled) {
      pullModelToNode();
    }
  });
  </script>

<script>
// Overall Dashboard - Models Display
async function fetchModels(){
  try{
    const res = await fetch('/api/tags', {credentials: 'same-origin'});
    if(!res.ok){ throw new Error('status '+res.status); }
    const data = await res.json();
    return data.models || [];
  }catch(e){
    console.error('fetchModels error', e);
    return [];
  }
}

function renderModels(models){
  const modelsList = document.getElementById('models-list');
  const modelCount = document.getElementById('model-count');
  
  if(!Array.isArray(models) || models.length === 0){
    modelCount.textContent = '0';
    modelsList.innerHTML = '<div class="loading-text">No models available</div>';
    return;
  }
  
  modelCount.textContent = models.length;
  
  const sortedModels = models.sort((a,b)=>(a.name||'').localeCompare(b.name||''));
  const modelsHtml = sortedModels.map(model => {
    const name = model.name || '';
    if(!name) return '';
    return `<div class="model-item">${name}</div>`;
  }).join('');
  
  modelsList.innerHTML = modelsHtml;
}

document.getElementById('refresh-models').addEventListener('click', async ()=>{
  document.getElementById('models-list').innerHTML = '<div class="loading-text">Loading...</div>';
  document.getElementById('model-count').textContent = '...';
  const models = await fetchModels();
  renderModels(models);
});

// Initial load
(async ()=>{ const m = await fetchModels(); renderModels(m); })();

// Pull to All Nodes functionality
async function fetchAllNodesStatus() {
  try {
    const res = await fetch('/api/proxy/active-requests', {credentials: 'same-origin'});
    if (!res.ok) { throw new Error('status ' + res.status); }
    const data = await res.json();
    return data.nodes || [];
  } catch (e) {
    console.error('fetchAllNodesStatus error', e);
    return [];
  }
}

function renderNodesPreview(nodes) {
  const previewDiv = document.getElementById('nodes-preview');
  
  if (!nodes || nodes.length === 0) {
    previewDiv.innerHTML = '<div class="preview-error">No active nodes available</div>';
    previewDiv.style.display = 'block';
    return;
  }
  
  const html = nodes.map(node => {
    const modelsCount = node.models ? node.models.length : 0;
    const statusClass = node.status === 'active' ? 'status-active' : 'status-standby';
    const modelsPreview = node.models && node.models.length > 0 
      ? node.models.slice(0, 3).join(', ') + (node.models.length > 3 ? '...' : '')
      : 'No models';
    
    return `
      <div class="node-preview-card">
        <div class="node-preview-header">
          <strong>${node.name}</strong>
          <span class="${statusClass}">${node.status}</span>
        </div>
        <div class="node-preview-info">
          <div>Models: ${modelsCount}</div>
          <div class="node-preview-models">${modelsPreview}</div>
        </div>
      </div>
    `;
  }).join('');
  
  previewDiv.innerHTML = html;
  previewDiv.style.display = 'block';
}

document.getElementById('show-nodes-preview').addEventListener('click', async () => {
  const previewDiv = document.getElementById('nodes-preview');
  previewDiv.innerHTML = '<div class="loading-text">Loading nodes status...</div>';
  previewDiv.style.display = 'block';
  
  const nodes = await fetchAllNodesStatus();
  renderNodesPreview(nodes);
});

document.getElementById('pull-all-submit').addEventListener('click', async () => {
  const modelName = document.getElementById('pull-all-model-input').value.trim();
  const statusDiv = document.getElementById('pull-all-status');
  const submitBtn = document.getElementById('pull-all-submit');
  
  if (!modelName) {
    statusDiv.style.display = 'block';
    statusDiv.className = 'pull-status pull-error';
    statusDiv.textContent = 'Please enter a model name';
    return;
  }
  
  submitBtn.disabled = true;
  statusDiv.style.display = 'block';
  statusDiv.className = 'pull-status pull-loading';
  statusDiv.textContent = 'Pulling model to all nodes... This may take several minutes.';
  
  try {
    const response = await fetch('/api/proxy/pull', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      },
      credentials: 'same-origin',
      body: JSON.stringify({
        model: modelName
      })
    });
    
    const data = await response.json();
    
    if (response.ok && data.results) {
      const successCount = data.results.filter(r => r.status === 'success').length;
      const totalCount = data.results.length;
      
      if (successCount === totalCount) {
        statusDiv.className = 'pull-status pull-success';
        statusDiv.textContent = `‚úì Successfully pulled to all ${totalCount} nodes`;
      } else {
        statusDiv.className = 'pull-status pull-error';
        statusDiv.textContent = `‚ö† Pulled to ${successCount}/${totalCount} nodes. Some failed.`;
      }
      
      // Show detailed results
      const detailsHtml = data.results.map(r => 
        `<div class="pull-result ${r.status === 'success' ? 'success' : 'error'}">
          ${r.node_name}: ${r.message}
        </div>`
      ).join('');
      statusDiv.innerHTML += `<div class="pull-results-detail">${detailsHtml}</div>`;
      
      submitBtn.disabled = false;
    } else {
      statusDiv.className = 'pull-status pull-error';
      statusDiv.textContent = `‚úó ${data.error || 'Failed to pull model'}`;
      submitBtn.disabled = false;
    }
  } catch (error) {
    statusDiv.className = 'pull-status pull-error';
    statusDiv.textContent = `‚úó Error: ${error.message}`;
    submitBtn.disabled = false;
  }
});
</script>

{% endblock %}
