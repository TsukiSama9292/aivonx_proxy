{% extends 'base.html' %}
{% load static %}

{% block title %}Manage Proxy{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/manage.css' %}">
{% endblock %}

{% block content %}
<!-- 1. Proxy Configuration Section -->
<section class="card shadow-sm mb-4">
  <div class="card-body">
    <div class="card-header d-flex align-items-center justify-content-between mb-3">
      <h2 class="fw-bold h5 mb-0">‚öôÔ∏è Proxy Configuration</h2>
    </div>
    <form method="post" class="row g-3 align-items-end">
      {% csrf_token %}
      <input type="hidden" name="action" value="update_config">
      <div class="col-12 col-md-6 col-lg-4">
        <label for="id_strategy" class="form-label">Strategy</label>
        {{ config_form.strategy }}
      </div>
      <div class="col-12 col-md-auto">
        <button type="submit" class="btn btn-primary">Save Config</button>
      </div>
    </form>
  </div>
</section>

<!-- 2. Overall Dashboard Section -->
<section class="card shadow-sm mb-4">
  <div class="card-body">
    <div class="card-header d-flex align-items-center justify-content-between mb-3">
      <h2 class="fw-bold h5 mb-0">üìä Overall Dashboard</h2>
    </div>

    <div class="row g-3">
      <!-- Available Models Card -->
      <div class="col-12 col-lg-6">
        <div class="card shadow-sm h-100">
          <div class="card-body d-flex flex-column">
            <div class="card-header d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
              <h3 class="fw-bold h6 mb-0">Available Models</h3>
              <button id="refresh-models" class="btn btn-outline-secondary btn-sm icon-btn" type="button">üîÑ</button>
            </div>
            <div class="text-center p-3 rounded bg-gradient model-count-display border border-dark-subtle mb-3">
              <div class="display-4 fw-bold mb-1" id="model-count">0</div>
              <div class="text-uppercase small fw-semibold">Total Models</div>
            </div>
            <div class="flex-grow-1 models-scroll-container">
              <div id="models-list" class="models-list">
                <div class="loading-text">Loading...</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Pull to All Nodes Card -->
      <div class="col-12 col-lg-6">
        <div class="card shadow-sm h-100">
          <div class="card-body d-flex flex-column">
            <div class="card-header d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
              <h3 class="fw-bold h6 mb-0">Pull Model to All Nodes</h3>
            </div>
            <div class="pull-all-form flex-grow-1 d-flex flex-column gap-3">
              <div class="mb-3">
                <label for="pull-all-model-input" class="form-label">Model Name</label>
                <input id="pull-all-model-input" type="text" list="model-suggestions-all" class="form-control" placeholder="Enter or select model name" />
                <datalist id="model-suggestions-all">
                  <option value="gpt-oss:20b">gpt-oss:20b</option>
                  <option value="embeddinggemma:300m">embeddinggemma:300m</option>
                </datalist>
              </div>
              <div class="d-flex flex-wrap gap-2">
                <button id="show-nodes-preview" class="btn btn-outline-secondary col-12" type="button">Preview Nodes Status</button>
                <button id="pull-all-submit" class="btn btn-primary col-12" type="button">Pull to All Active Nodes</button>
              </div>
              <div id="nodes-preview" class="nodes-preview row row-cols-1 row-cols-md-2 g-3 d-none"></div>
              <div id="pull-all-status" class="pull-status alert text-center d-none"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</section>

<!-- 3. Nodes Dashboard Section -->
<section class="card shadow-sm">
  <div class="card-body">
    <div class="card-header d-flex justify-content-between align-items-center mb-3">
      <h2 class="fw-bold h5 mb-0">üñ•Ô∏è Nodes Dashboard</h2>
      <button id="open-add-node" class="btn btn-primary btn-sm add-node-btn" type="button">+ Add Node</button>
    </div>
    <div class="table-responsive">
      <table class="table table-striped table-hover align-middle nodes">
        <thead class="table-light text-center">
          <tr>
            <th>ID</th>
            <th class="text-end" style="width: 15%;">Name</th>
            <th class="text-end" style="width: 25%;">Address</th>
            <th style="width: 10%;">Port</th>
            <th>Active</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for n in nodes %}
          <tr>
            <td class="text-center">{{ n.id }}</td>
            <td class="text-end">{{ n.name }}</td>
            <td class="text-end">{{ n.address }}</td>
            <td class="text-center">{{ n.port }}</td>
            <td class="text-center">
              {% if n.active %}
              <span class="badge bg-success">True</span>
              {% else %}
              <span class="badge bg-secondary">False</span>
              {% endif %}
            </td>
            <td class="text-center">
              <div class="btn-group btn-group-sm" role="group">
                <button class="btn btn-outline-info details-node-btn" style="min-width: 5.5rem;" data-id="{{ n.id }}">Details</button>
                <button class="btn btn-outline-primary pull-node-btn" style="min-width: 5.5rem;" data-id="{{ n.id }}" data-name="{{ n.name }}">Pull</button>
                <button class="btn btn-outline-success edit-node-btn" style="min-width: 5.5rem;" data-id="{{ n.id }}" data-name="{{ n.name }}" data-address="{{ n.address }}" data-port="{{ n.port }}">Update</button>
              </div>
              <form method="post" class="d-inline ms-2">
                {% csrf_token %}
                <input type="hidden" name="action" value="delete_node">
                <input type="hidden" name="node_id" value="{{ n.id }}">
                <button type="submit" class="btn btn-danger btn-sm" style="min-width: 5.5rem;">Delete</button>
              </form>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="6" class="text-center text-muted py-3">No nodes configured</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</section>

<!-- Modals -->
<div id="node-modal" class="modal-backdrop-custom">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-3">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h3 id="modal-title" class="h5 mb-0">Edit Node</h3>
        <button id="modal-close" class="btn-close"></button>
      </div>
      <form id="modal-form" method="post" class="needs-validation" novalidate>
        {% csrf_token %}
        <input type="hidden" name="node_id" id="modal-node-id" value="">
        <input type="hidden" name="action" id="modal-action" value="">
        <div class="mb-3">
          <label for="modal-name" class="form-label">Name</label>
          <input id="modal-name" type="text" name="name" class="form-control" required />
        </div>
        <div class="mb-3">
          <label for="modal-address" class="form-label">Domain / IP</label>
          <input id="modal-address" type="text" name="address" class="form-control" required />
        </div>
        <div class="mb-3">
          <label for="modal-port" class="form-label">Port</label>
          <input id="modal-port" type="number" name="port" class="form-control" required />
        </div>
        <div class="d-grid">
          <button type="submit" id="modal-submit" class="btn btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div id="details-modal" class="modal-backdrop-custom">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content p-3">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h3 id="details-modal-title" class="h5 mb-0">Node Details</h3>
        <button id="details-modal-close" class="btn-close"></button>
      </div>
      <div id="details-content" class="details-content">
        <div class="details-loading text-center py-3 text-muted">Loading...</div>
      </div>
    </div>
  </div>
</div>

<div id="pull-modal" class="modal-backdrop-custom">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content p-3">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h3 id="pull-modal-title" class="h5 mb-0">Pull Model</h3>
        <button id="pull-modal-close" class="btn-close"></button>
      </div>
      <div id="pull-modal-body">
        <div id="pull-node-info" class="pull-node-info alert alert-light border mb-3">
          <div class="pull-info-loading text-center text-muted">Loading node information...</div>
        </div>
        <div class="mb-3">
          <label for="pull-model-input" class="form-label">Model Name</label>
          <input id="pull-model-input" type="text" list="model-suggestions" class="form-control" placeholder="Enter or select model name" required />
          <datalist id="model-suggestions">
            <option value="gpt-oss:20b">gpt-oss:20b</option>
            <option value="embeddinggemma:300m">embeddinggemma:300m</option>
          </datalist>
        </div>
        <div id="pull-status" class="pull-status alert text-center d-none"></div>
        <div class="d-grid">
          <button id="pull-submit" class="btn btn-primary pull-submit-btn" type="button">Pull Model</button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_body %}
<script src="{% static 'js/manage.js' %}"></script>
{% endblock %}